<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Busca CEP - Projeto Faculdade</title>
    <style>
        .escondido { display: none; }
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; }
        .card { border: 1px solid #ccc; padding: 15px; margin-top: 10px; border-radius: 8px; background-color: #f9f9f9; }
        button { padding: 10px 20px; background-color: #007bff; color: white; border: none; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        input { padding: 10px; width: 200px; }
    </style>
</head>
<body>
    <h2>Consultar CEP</h2>
    <input type="text" id="cepInput" placeholder="00000-000" maxlength="9" oninput="mascaraCep(this)">
    <button onclick="buscarCep()">Buscar</button>
    <button onclick="gerarRelatorio()" style="background-color: #28a745; margin-left: 10px;">
        Imprimir Relatório (TXT)
    </button>
    <div id="resultado" class="card escondido">
        <h3>Resultado:</h3>
        <p><strong>Rua:</strong> <span id="rua"></span></p>
        <p><strong>Cidade:</strong> <span id="cidade"></span></p>
        <p><strong>Estado:</strong> <span id="estado"></span></p>
    </div>

    <h3>Histórico de Buscas (Banco de Dados)</h3>
    <ul id="listaHistorico"></ul>

    <script>
        function mascaraCep(input) {
            let value = input.value.replace(/\D/g, "");
            if (value.length > 5) {
                value = value.replace(/^(\d{5})(\d)/, "$1-$2");
            }
            input.value = value;
        }

        async function buscarCep() {
            let cep = document.getElementById('cepInput').value.replace("-", "");

            if (cep.length !== 8) {
                alert("O CEP deve ter 8 números!");
                return;
            }

            const resposta = await fetch('/api/consulta', {
                method: 'POST',
                headers: {
                    'Content-Type': 'text/plain'
                },
                body: cep
            });

            if (!resposta.ok) {
                alert("Erro ao buscar CEP. Verifique o console.");
                return;
            }

            const dados = await resposta.json();

            if(dados.cep) {
                document.getElementById('rua').innerText = dados.logradouro;
                document.getElementById('cidade').innerText = dados.localidade;
                document.getElementById('estado').innerText = dados.uf;
                document.getElementById('resultado').classList.remove('escondido');
                carregarHistorico();
            } else {
                alert("CEP não encontrado!");
            }
        }

        async function carregarHistorico() {
            const resposta = await fetch('/api/historico');
            const lista = await resposta.json();
            
            const ul = document.getElementById('listaHistorico');
            ul.innerHTML = ''; 

            lista.forEach(item => {
                const li = document.createElement('li');
                const cepFormatado = item.cep.replace(/^(\d{5})(\d)/, "$1-$2");
                li.innerText = `${cepFormatado} - ${item.logradouro}, ${item.localidade}`;
                ul.appendChild(li);
            });
        }

        async function gerarRelatorio() {
            alert("Gerando relatório na pasta Downloads...");

            const resposta = await fetch('/api/relatorio');
            
            const texto = await resposta.text();

            alert(texto);
        }

        carregarHistorico();
    </script>
</body>
</html>